---
import logoLight from "../../../public/images/brand/logomark/nuva-logomark-colored-light.svg?raw";
import logoDark from "../../../public/images/brand/logomark/nuva-logomark-colored-dark.svg?raw";
import Button from "../dumb/Button.astro";
import Icon from "../dumb/Icon.astro";
import { Menu, Search, X, Sun, Moon } from "lucide";
---

<nav id="nav" class="font-sans">
    <div class="fixed w-full top-0 right-0 left-0 backdrop-blur-xl z-10 border-b border-border/30 bg-background/80">
        <div class="px-4 md:px-8 max-w-screen-2xl mx-auto h-14 lg:h-16 flex items-center justify-between">
            <a
                href="/"
                class="flex gap-2 text-foreground items-center hover:text-primary-500 transition-colors duration-200"
            >
                <span class="logo hidden dark:block w-8 md:w-10 h-auto text-current">
                    <Fragment set:html={logoDark} />
                </span>
                <span class="logo block dark:hidden w-8 md:w-10 h-auto text-current">
                    <Fragment set:html={logoLight} />
                </span>
            </a>

            <div class="hidden md:flex gap-8 items-center absolute left-1/2 -translate-x-1/2">
                <a href="/projects" class="text-foreground/60 hover:text-foreground transition-colors duration-200 text-[0.9rem]">Projects</a>
                <a href="/about" class="text-foreground/60 hover:text-foreground transition-colors duration-200 text-[0.9rem]">About</a>
                <a href="/contact" class="text-foreground/60 hover:text-foreground transition-colors duration-200 text-[0.9rem]">Contact</a>
            </div>

            <div class="flex gap-1 items-center">
                <button
                    data-theme-toggle-trigger
                    title="Change theme"
                    type="button"
                    class="w-9 h-9 flex items-center justify-center rounded-lg text-foreground/40 hover:text-foreground hover:bg-foreground/5 transition-all duration-200"
                >
                    <Icon class="dark:block hidden w-[18px] h-[18px]" icon={Moon} />
                    <Icon class="dark:hidden block w-[18px] h-[18px]" icon={Sun} />
                </button>
                <button
                    data-search-open-trigger
                    title="Open search"
                    type="button"
                    class="w-9 h-9 flex items-center justify-center rounded-lg text-foreground/40 hover:text-foreground hover:bg-foreground/5 transition-all duration-200"
                >
                    <Icon class="w-[18px] h-[18px]" icon={Search} />
                </button>
                <button
                    data-menu-open-trigger
                    title="Open menu"
                    type="button"
                    class="md:hidden w-9 h-9 flex items-center justify-center rounded-lg text-foreground/40 hover:text-foreground hover:bg-foreground/5 transition-all duration-200"
                >
                    <Icon class="w-[18px] h-[18px]" icon={Menu} />
                </button>
                <div class="hidden md:block ml-2">
                    <Button size="sm" variant="primary" href="/contact">Get in touch</Button>
                </div>
            </div>
        </div>
    </div>

    <dialog
        data-nav-menu
        class="fixed inset-0 bg-transparent w-full h-screen z-10 open:flex flex-col justify-center items-center p-4"
    >
        <div data-menu-close-trigger class="bg-background/80 backdrop-blur-xl w-full h-full absolute inset-0"></div>

        <a
            href="/"
            class="relative mx-auto mb-auto pt-8 flex gap-2 text-foreground items-center justify-center hover:text-primary-500 transition-colors duration-200"
        >
            <span class="logo hidden dark:block w-16 md:w-20 h-auto text-current">
                <Fragment set:html={logoDark} />
            </span>
            <span class="logo block dark:hidden w-16 md:w-20 h-auto text-current">
                <Fragment set:html={logoLight} />
            </span>
        </a>
        <div class="relative my-auto flex flex-col gap-6 text-center">
            <a
                href="/projects"
                class="text-foreground text-2xl font-serif font-bold hover:text-primary-500 transition-colors duration-200"
                >Projects</a
            >
            <a
                href="/about"
                class="text-foreground text-2xl font-serif font-bold hover:text-primary-500 transition-colors duration-200"
                >About</a
            >
            <div class="mt-2">
                <Button size="md" variant="primary" href="/contact">Get in touch</Button>
            </div>
        </div>
        <div class="relative mt-auto pb-8">
            <button
                data-menu-close-trigger
                title="Close menu"
                type="button"
                class="flex gap-2 items-center text-foreground/50 hover:text-foreground transition-colors duration-200"
            >
                <Icon class="w-5 h-5" icon={X} />
                <span>Close</span>
            </button>
        </div>
    </dialog>
    <dialog
        data-nav-search
        class="fixed inset-0 bg-transparent w-full h-screen z-10 open:flex flex-col justify-center items-center p-4"
    >
        <div data-search-close-trigger class="bg-background/80 backdrop-blur-xl w-full h-full absolute inset-0"></div>
        <a
            href="/"
            class="relative mx-auto mb-auto pt-8 flex gap-2 text-foreground items-center justify-center hover:text-primary-500 transition-colors duration-200"
        >
            <span class="logo hidden dark:block w-16 md:w-20 h-auto text-current">
                <Fragment set:html={logoDark} />
            </span>
            <span class="logo block dark:hidden w-16 md:w-20 h-auto text-current">
                <Fragment set:html={logoLight} />
            </span>
        </a>
        <form class="relative my-auto flex gap-3 text-center justify-center items-center w-full max-w-md px-4" action="/search">
            <input name="q" type="search" class="w-full p-3 border border-border rounded-lg bg-background text-foreground" autofocus placeholder="Search..." />
            <button type="submit" class="text-foreground p-3 rounded-lg hover:bg-foreground/5 transition-colors duration-200">
                <Icon class="w-5 h-5" icon={Search} />
            </button>
        </form>
        <div class="relative mt-auto pb-8">
            <button
                data-search-close-trigger
                title="Close search"
                type="button"
                class="flex gap-2 items-center text-foreground/50 hover:text-foreground transition-colors duration-200"
            >
                <Icon class="w-5 h-5" icon={X} />
                <span>Close</span>
            </button>
        </div>
    </dialog>
</nav>

<script>
    (function () {
        const nav = document.getElementById("nav");

        if (!nav) {
            throw new Error("No nav element found");
        }

        setupMenu(nav);
        setupSearch(nav);
        setupTheme();
    })();

    function setupMenu(nav: HTMLElement) {
        const navMenuDialog = nav.querySelector("dialog[data-nav-menu]");
        if (!navMenuDialog) {
            throw new Error("No dialog element found");
        }

        const menuOpenButtons = document.querySelectorAll("[data-menu-open-trigger]");
        menuOpenButtons.forEach((button) => {
            button.addEventListener("click", () => {
                navMenuDialog.setAttribute("open", "");
                // @ts-ignore
                navMenuDialog.focus();
                window.addEventListener("keydown", handleEscapeKey);
            });
        });

        const menuCloseButtons = document.querySelectorAll("[data-menu-close-trigger]");
        menuCloseButtons.forEach((button) => {
            button.addEventListener("click", () => {
                navMenuDialog.removeAttribute("open");
                // @ts-ignore
                menuOpenButtons[0].focus();
                window.removeEventListener("keydown", handleEscapeKey);
            });
        });

        const handleEscapeKey = (event: KeyboardEvent) => {
            if (event.key === "Escape") {
                navMenuDialog.removeAttribute("open");
                // @ts-ignore
                menuOpenButtons[0].focus();
                window.removeEventListener("keydown", handleEscapeKey);
            }
        };
    }

    function setupSearch(nav: HTMLElement) {
        const navSearchDialog = nav.querySelector("dialog[data-nav-search]");
        if (!navSearchDialog) {
            throw new Error("No dialog element found");
        }

        const searchInputElement = navSearchDialog.querySelector("input");
        if (!searchInputElement) {
            throw new Error("No input element found");
        }

        const searchOpenButtons = document.querySelectorAll("[data-search-open-trigger]");
        searchOpenButtons.forEach((button) => {
            button.addEventListener("click", () => {
                navSearchDialog.setAttribute("open", "");
                searchInputElement.focus();
                window.addEventListener("keydown", handleEscapeKey);
            });
        });

        const searchCloseButtons = document.querySelectorAll("[data-search-close-trigger]");
        searchCloseButtons.forEach((button) => {
            button.addEventListener("click", () => {
                navSearchDialog.removeAttribute("open");
                // @ts-ignore
                searchOpenButtons[0].focus();
                window.removeEventListener("keydown", handleEscapeKey);
            });
        });

        const handleEscapeKey = (event: KeyboardEvent) => {
            if (event.key === "Escape") {
                navSearchDialog.removeAttribute("open");
                // @ts-ignore
                searchOpenButtons[0].focus();
                window.removeEventListener("keydown", handleEscapeKey);
            }
        };
    }

    function setupTheme() {
        initialize();

        const themeToggleButtons = document.querySelectorAll("[data-theme-toggle-trigger]");
        themeToggleButtons.forEach((button) => {
            button.addEventListener("click", () => {
                const savedTheme = localStorage.getItem("theme");
                applyTheme(savedTheme === "light" ? "dark" : "light");
            });
        });

        function initialize() {
            const preferredTheme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
            const savedTheme = localStorage.getItem("theme");

            if (!savedTheme) {
                localStorage.setItem("theme", preferredTheme);
                applyTheme(preferredTheme);
            } else {
                applyTheme(savedTheme as "light" | "dark");
            }
        }

        function applyTheme(theme: "light" | "dark") {
            document.documentElement.classList.remove("dark");
            document.documentElement.classList.remove("light");
            document.documentElement.classList.add(theme);
            localStorage.setItem("theme", theme);
        }
    }
</script>

<style is:global>
    #nav .logo svg {
        width: 100%;
        height: auto;
    }
</style>
